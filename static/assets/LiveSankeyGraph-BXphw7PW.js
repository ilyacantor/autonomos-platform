import{r as u,j as R,A as st}from"./index-cApqyF4s.js";import{s as l,S as ft,a as ht}from"./d3-vendor-BvNdi-GT.js";import"./react-vendor-BdZgHC1P.js";function vt({isActive:i=!0}){const S=u.useRef(null),w=u.useRef(null),[x,v]=u.useState(null),[c,m]=u.useState(new Set),[d,$]=u.useState({width:0,height:0}),[T,_]=u.useState(!1),k=u.useRef(null);u.useEffect(()=>{if(!i)return;const p=async()=>{try{const E=await(await fetch(st.buildDclUrl("/state"))).json();v(E)}catch(y){console.error("Error fetching state:",y)}};p();const f=()=>p();return window.addEventListener("dcl-state-changed",f),()=>window.removeEventListener("dcl-state-changed",f)},[i]),u.useLayoutEffect(()=>{if(!(!x||!S.current||!w.current)&&!(!x.graph||!x.graph.nodes||x.graph.nodes.length===0)&&!(d.width===0||d.height===0))return _(!0),k.current&&cancelAnimationFrame(k.current),k.current=requestAnimationFrame(()=>{ut(x,S.current,w.current,c),_(!1)}),()=>{k.current&&cancelAnimationFrame(k.current)}},[x,c,d]);const H=p=>{m(f=>new Set(f).add(p)),setTimeout(()=>{m(f=>{const y=new Set(f);return y.delete(p),y})},2e3)};return u.useEffect(()=>{const p=f=>{const{type:y,sourceId:E,targetId:M}=f.detail;(y==="new_source"||y==="source_removed"||y==="fault"||y==="schema_drift")&&H(`${E}-${M}`)};return window.addEventListener("dcl-graph-event",p),()=>window.removeEventListener("dcl-graph-event",p)},[]),u.useEffect(()=>{if(!w.current)return;let p=null;const f=new ResizeObserver(y=>{p&&cancelAnimationFrame(p),p=requestAnimationFrame(()=>{for(const E of y){const{width:M,height:h}=E.contentRect;M>0&&h>0&&$({width:M,height:h})}})});return f.observe(w.current),()=>{p&&cancelAnimationFrame(p),f.disconnect()}},[]),R.jsxs("div",{ref:w,className:"rounded-xl bg-gray-800/40 border border-gray-700 shadow-sm ring-1 ring-cyan-500/10 p-1 w-full md:min-h-[400px] flex items-center justify-center",children:[T&&d.width===0&&R.jsx("div",{className:"flex items-center justify-center md:min-h-[400px]",children:R.jsx("div",{className:"text-sm text-gray-400 animate-pulse",children:"Loading graph..."})}),R.jsx("svg",{ref:S,className:"w-full h-auto",style:{display:"block"}})]})}function j(i,S){return{fill:"#1e293b",stroke:"#475569",strokeWidth:1,fillOpacity:1}}function ut(i,S,w,x){const v=l(S);if(v.selectAll("*").remove(),!i.graph||!i.graph.nodes||i.graph.nodes.length===0){v.append("text").attr("x","50%").attr("y","50%").attr("text-anchor","middle").attr("fill","#94a3b8").attr("font-size","14px").text('No data available. Click "Connect & Map" to start.');return}const c=[],m=[],d={};let $=0;i.graph.nodes.forEach(t=>{d[t.id]=$,c.push({name:t.label,type:t.type,id:t.id,sourceSystem:t.sourceSystem,parentId:t.parentId}),$++}),i.graph.edges.forEach(t=>{if(d[t.source]!==void 0&&d[t.target]!==void 0){const n=i.graph.nodes.find(a=>a.id===t.source),e=i.graph.nodes.find(a=>a.id===t.target),o=t.edgeType??t.edge_type??"dataflow";m.push({source:d[t.source],target:d[t.target],value:1,edgeType:o,sourceSystem:n?.sourceSystem,targetType:e?.type,fieldMappings:t.field_mappings||[],edgeLabel:t.label||"",entityFields:t.entity_fields||[],entityName:t.entity_name||""})}});const T=w.getBoundingClientRect(),_=Math.max(T.width,320),k=window.innerWidth<768,H=Math.max(T.height,k?200:400),p={source_parent:0,source:1,ontology:2,agent:3},f=c.length,y=Math.min(H,100+f*40),M=ft().nodeWidth(8).nodePadding(18).extent([[1,20],[_-1,y-20]])({nodes:c.map(t=>Object.assign({},t)),links:m.map(t=>Object.assign({},t))}),{nodes:h,links:z}=M,P=20,D=20,q=(_-P-D)/3,F=[P,P+q,P+q*2,_-D-8];h.forEach(t=>{const n=c.find(e=>e.name===t.name);if(n&&n.type&&p[n.type]!==void 0){const e=p[n.type];t.depth=e,t.x0=F[e],t.x1=F[e]+8}else t.depth=1,t.x0=F[1],t.x1=F[1]+8});const W=()=>{z.forEach(t=>{const n=t.source,e=t.target;t.y0=n.y0+(n.y1-n.y0)/2,t.y1=e.y0+(e.y1-e.y0)/2})};W();const L=h.filter(t=>{const n=c.find(e=>e.name===t.name);return n&&n.type==="ontology"});if(L.length>1){const t=L.reduce((a,s)=>a+(s.y1-s.y0),0),e=(y-t-80)/(L.length-1);let o=40;L.forEach(a=>{const s=a.y1-a.y0;a.y0=o,a.y1=o+s,o+=s+e}),W()}const A=h.filter(t=>{const n=c.find(e=>e.name===t.name);return n&&n.type==="agent"});if(A.length>0){const t=A.reduce((s,r)=>s+(r.y1-r.y0),0),n=40,e=(A.length-1)*n;let a=(y-t-e)/2;A.forEach(s=>{const r=s.y1-s.y0;s.y0=a,s.y1=a+r,a+=r+n}),W()}const rt={dynamics:{parent:"#3b82f6",child:"#60a5fa"},salesforce:{parent:"#8b5cf6",child:"#a78bfa"},sap:{parent:"#10b981",child:"#34d399"},netsuite:{parent:"#f59e0b",child:"#fbbf24"},legacy_sql:{parent:"#ef4444",child:"#f87171"},snowflake:{parent:"#06b6d4",child:"#22d3ee"},supabase:{parent:"#14b8a6",child:"#2dd4bf"},mongodb:{parent:"#10b981",child:"#34d399"}},K=Math.min(...h.map(t=>t.x0)),it=Math.max(...h.map(t=>t.x1)),J=Math.min(...h.map(t=>t.y0)),lt=Math.max(...h.map(t=>t.y1)),ct=it-K,pt=lt-J;let C=0;const Q=v.append("g");h.forEach(t=>{const n=c.find(e=>e.name===t.name);if(n&&(n.type==="source_parent"||n.type==="ontology"||n.type==="agent")){let e=t.name||"Unknown";n.type==="ontology"&&(e=e.replace(/\s*\(unified\)\s*/i,"").trim()),n.type;const g=(Q.append("text").attr("font-size",10).attr("font-family","system-ui, -apple-system, sans-serif").text(e).node()?.getComputedTextLength()||0)+4*2;C=Math.max(C,g)}}),Q.remove();const V=8,Y=20,dt=2,Z=20,yt=Y+V+C,tt=K-Z,et=J-Y,nt=ct+Z+yt,B=pt+Y+dt;v.attr("viewBox",`${tt} ${et} ${nt} ${B}`).attr("preserveAspectRatio","xMidYMid meet").attr("height",B),v.append("defs").append("clipPath").attr("id","graph-clip").append("rect").attr("x",tt).attr("y",et).attr("width",nt).attr("height",B);const ot=v.append("g").attr("clip-path","url(#graph-clip)");ot.append("g").attr("fill","none").selectAll("path").data(z).join("path").attr("d",ht()).attr("stroke",(t,n)=>{const e=m[n],o=i.graph.nodes.find(s=>d[s.id]===e.source),a=c.find(s=>s.name===t.target.name);return e?.edgeType==="hierarchy"&&o?.type==="source_parent"?"#22c55e":e?.edgeType==="hierarchy"?"#475569":a&&a.type==="agent"?"#9333ea":e&&e.sourceSystem?rt[e.sourceSystem]?.child||"#0bcad9":"#94a3b8"}).attr("stroke-width",t=>Math.min(Math.max(.5,t.width*.5),20)).attr("stroke-opacity",(t,n)=>{const e=m[n];if(e?.edgeType==="hierarchy")return .35;const o=i.graph.nodes.find(r=>d[r.id]===e.source),a=i.graph.nodes.find(r=>d[r.id]===e.target),s=`${o?.id}-${a?.id}`;return x.has(s)?.9:o&&(o.type==="source"||o.type==="source_parent")?.7:.4}).attr("class",(t,n)=>{const e=m[n],o=i.graph.nodes.find(r=>d[r.id]===e.source),a=i.graph.nodes.find(r=>d[r.id]===e.target),s=`${o?.id}-${a?.id}`;return x.has(s)?"animate-pulse":""}).style("cursor","pointer").on("mouseenter",function(t,n){const e=z.indexOf(n),o=m[e];o?.edgeType==="hierarchy"?l(this).attr("stroke-opacity",.6):l(this).attr("stroke-opacity",.7);const a=c.find(b=>b.name===n.source.name),s=c.find(b=>b.name===n.target.name),r=gt(a,s,o);l("body").selectAll(".sankey-edge-tooltip").data([null]).join("div").attr("class","sankey-edge-tooltip").style("position","fixed").style("background","rgba(15, 23, 42, 0.95)").style("color","#e2e8f0").style("padding","8px 12px").style("border-radius","6px").style("border","1px solid #475569").style("font-size","12px").style("pointer-events","none").style("z-index","10000").style("box-shadow","0 4px 6px rgba(0, 0, 0, 0.3)").style("max-width","400px").style("font-family","system-ui, -apple-system, sans-serif").html(r).style("left",t.pageX+10+"px").style("top",t.pageY-10+"px").style("opacity","1").style("display","block")}).on("mousemove",function(t){l(".sankey-edge-tooltip").style("left",t.pageX+10+"px").style("top",t.pageY-10+"px")}).on("mouseleave",function(t,n){const e=z.indexOf(n),o=m[e];if(o?.edgeType==="hierarchy")l(this).attr("stroke-opacity",.35);else{const a=i.graph.nodes.find(s=>d[s.id]===o.source);a&&(a.type==="source"||a.type==="source_parent")?l(this).attr("stroke-opacity",.7):l(this).attr("stroke-opacity",.4)}l(".sankey-edge-tooltip").style("opacity","0").style("display","none")});const at=ot.append("g").selectAll("g").data(h).join("g"),I=l("body").selectAll(".sankey-tooltip").data([null]).join("div").attr("class","sankey-tooltip").style("position","absolute").style("background","rgba(15, 23, 42, 0.95)").style("color","#e2e8f0").style("padding","8px 12px").style("border-radius","6px").style("border","1px solid #475569").style("font-size","12px").style("pointer-events","none").style("opacity","0").style("z-index","1000").style("box-shadow","0 4px 6px rgba(0, 0, 0, 0.3)");at.append("rect").attr("x",t=>t.x0).attr("y",t=>t.y0).attr("width",t=>t.x1-t.x0).attr("height",t=>Math.max(t.y1-t.y0,2)).attr("fill",t=>j().fill).attr("fill-opacity",t=>{const n=j(),e=c.find(o=>o.name===t.name);return e?.type==="ontology"?.9:e?.type==="source"?i.graph.edges.some(a=>a.source===e.id&&(a.edgeType??a.edge_type)==="dataflow")?1:.5:e?.type==="agent"?0:e?.type==="source_parent"?.7:n.fillOpacity}).attr("stroke",t=>j().stroke).attr("stroke-width",t=>j().strokeWidth).attr("stroke-opacity",t=>{const n=c.find(e=>e.name===t.name);return n?.type==="source"?i.graph.edges.some(o=>o.source===n.id&&(o.edgeType??o.edge_type)==="dataflow")?1:.6:n?.type==="agent"||n?.type==="source_parent"?1:0}).style("cursor","pointer").on("mouseenter",function(t,n){const e=c.find(a=>a.name===n.name);if(!e)return;e.type==="ontology"?l(this).attr("fill-opacity",1):(e.type==="source"||e.type==="agent")&&l(this).attr("stroke-opacity",1);let o=`<strong>${n.name}</strong><br/>`;o+=`Type: ${e.type}`,(e.type==="source"||e.type==="source_parent")&&(o+=`<br/>System: ${e.sourceSystem||"Unknown"}`),I.html(o).style("opacity","1").style("left",t.pageX+10+"px").style("top",t.pageY-10+"px")}).on("mousemove",function(t){I.style("left",t.pageX+10+"px").style("top",t.pageY-10+"px")}).on("mouseleave",function(t,n){const e=c.find(o=>o.name===n.name);if(e?.type==="ontology")l(this).attr("fill-opacity",.9);else if(e?.type==="source"){const o=i.graph.edges.some(a=>a.source===e.id&&(a.edgeType??a.edge_type)==="dataflow");l(this).attr("fill-opacity",o?1:.5),l(this).attr("stroke-opacity",o?1:.6)}else e?.type==="agent"?l(this).attr("fill-opacity",0).attr("stroke-opacity",1):e?.type==="source_parent"?l(this).attr("fill-opacity",.7).attr("stroke-opacity",1):l(this).attr("fill-opacity",.7);I.style("opacity","0")}).on("click",async function(t,n){const e=c.find(o=>o.name===n.name);if(e)try{const a=await(await fetch(st.buildDclUrl(`/preview?node=${e.id}`))).json();console.log("Preview data for",e.id,":",a),window.dispatchEvent(new CustomEvent("sankey-node-click",{detail:{node:e,preview:a}}))}catch(o){console.error("Error fetching preview:",o)}});const U=[];at.each(function(t){const n=c.find(e=>e.name===t.name);if(n&&(n.type==="source_parent"||n.type==="ontology"||n.type==="agent")){let e=t.name||"Unknown";n.type==="ontology"&&(e=e.replace(/\s*\(unified\)\s*/i,"").trim()),n.type;const o=4,a=10,s=16,r=l(this).append("text").attr("font-size",a).attr("font-family","system-ui, -apple-system, sans-serif").text(e),g=r.node()?.getComputedTextLength()||0;r.remove();const b=g+o*2,G=t.x1+V,X=(t.y0+t.y1)/2;let O="#475569";n.type==="source_parent"?O="#22c55e":n.type==="ontology"?O="#60a5fa":n.type==="agent"&&(O="#9333ea"),U.push({element:this,nodeData:n,d:t,label:e,fontSize:a,pillHeight:s,pillWidth:b,padding:o,xPos:G,yPos:X,borderColor:O})}});const N=new Map;U.forEach(t=>{const n=Math.round(t.xPos);N.has(n)||N.set(n,[]),N.get(n).push(t)}),N.forEach(t=>{t.sort((e,o)=>e.yPos-o.yPos);const n=4;for(let e=1;e<t.length;e++){const o=t[e-1],a=t[e],s=o.yPos+o.pillHeight/2,r=a.yPos-a.pillHeight/2;if(s+n>r){const g=s+n-r;a.yPos+=g}}}),U.forEach(t=>{const n=l(t.element).append("g").attr("class","node-label-group").attr("transform",`translate(${t.d.x1+8}, ${t.yPos})`);n.append("rect").attr("x",0).attr("y",-t.pillHeight/2).attr("width",t.pillWidth).attr("height",t.pillHeight).attr("rx",t.pillHeight/2).attr("ry",t.pillHeight/2).attr("fill","#1e293b").attr("stroke",t.borderColor).attr("stroke-width",1.5).attr("fill-opacity",.9).attr("stroke-opacity",.9),n.append("text").attr("x",t.pillWidth/2).attr("y",0).attr("text-anchor","middle").attr("dominant-baseline","central").attr("fill","#e2e8f0").attr("font-size",t.fontSize).attr("font-family","system-ui, -apple-system, sans-serif").attr("font-weight","500").attr("pointer-events","none").text(t.label)});function gt(t,n,e){if(!t||!n)return"Data Flow";const o=t.name||"Unknown",a=n.name||"Unknown";let s="";t.type==="source_parent"&&n.type==="source"?s="System to table connection":t.type==="source"&&n.type==="ontology"?s="Raw data mapped to unified schema":t.type==="ontology"&&n.type==="agent"?s="Ontology field consumed by agent":s="Data flow";let r=`
      <strong>Data Flow</strong><br>
      <span style="color: #94a3b8; font-size: 10px;">${s}</span><br>
      <div style="margin-top: 4px; padding-top: 4px; border-top: 1px solid #475569;">
        <span style="color: #60a5fa;">From:</span> ${o}<br>
        <span style="color: #34d399;">To:</span> ${a}
      </div>
    `;if(t.type==="source_parent"&&n.type==="source"&&e?.tableFields?.length&&(r+=`
        <div style="margin-top: 6px; padding-top: 6px; border-top: 1px solid #475569;">
          <strong style="color: #a78bfa; font-size: 10px;">Table Fields:</strong><br>
          <div style="max-height: 120px; overflow-y: auto; margin-top: 4px;">
      `,e.tableFields.forEach(g=>{r+=`
          <div style="font-size: 10px; margin: 2px 0; color: #cbd5e1;">
            <span style="color: #60a5fa;">•</span> ${g}
          </div>
        `}),r+="</div></div>"),e?.fieldMappings?.length&&(r+=`
        <div style="margin-top: 6px; padding-top: 6px; border-top: 1px solid #475569;">
          <strong style="color: #a78bfa; font-size: 10px;">Field Mappings:</strong><br>
          <div style="max-height: 120px; overflow-y: auto; margin-top: 4px;">
      `,e.fieldMappings.forEach(g=>{const b=g.source||"N/A",G=g.onto_field||"N/A",X=g.confidence?`(${Math.round(g.confidence*100)}%)`:"";r+=`
          <div style="font-size: 10px; margin: 2px 0; color: #cbd5e1;">
            <span style="color: #60a5fa;">${b}</span> → <span style="color: #34d399;">${G}</span> <span style="color: #94a3b8;">${X}</span>
          </div>
        `}),r+="</div></div>"),t.type==="ontology"&&n.type==="agent"&&e?.entityFields?.length){const g=e.entityName||"entity";r+=`
        <div style="margin-top: 6px; padding-top: 6px; border-top: 1px solid #475569;">
          <strong style="color: #a78bfa; font-size: 10px;">Unified ${g.replace("_"," ").toUpperCase()} Fields:</strong><br>
          <div style="max-height: 120px; overflow-y: auto; margin-top: 4px;">
      `,e.entityFields.forEach(b=>{r+=`
          <div style="font-size: 10px; margin: 2px 0; color: #cbd5e1;">
            <span style="color: #34d399;">•</span> ${b}
          </div>
        `}),r+="</div></div>"}return r}}export{vt as default};
