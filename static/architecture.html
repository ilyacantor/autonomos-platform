<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutonomOS Architecture</title>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true });
    </script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            border-bottom: 2px solid #333;
            padding-bottom: 10px;
        }
        h2 {
            margin-top: 40px;
            padding-bottom: 8px;
            border-bottom: 1px solid #ddd;
        }
        nav {
            background: #f5f5f5;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        nav ul {
            list-style: none;
            padding: 0;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        nav a {
            text-decoration: none;
            padding: 8px 15px;
            background: #007bff;
            color: white;
            border-radius: 4px;
        }
        nav a:hover {
            background: #0056b3;
        }
        .mermaid {
            background: #fafafa;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        @media (max-width: 768px) {
            nav ul {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <h1>AutonomOS Platform Architecture</h1>
    <p>Multi-Tenant AI Orchestration Platform - Visual Documentation</p>

    <nav>
        <h3>Quick Navigation</h3>
        <ul>
            <li><a href="#overview">High-Level Architecture</a></li>
            <li><a href="#dataflow">Data Flow</a></li>
            <li><a href="#aam">AAM Components</a></li>
            <li><a href="#middleware">Middleware Stack</a></li>
            <li><a href="#database">Database Schema</a></li>
            <li><a href="#frontend">Frontend Architecture</a></li>
        </ul>
    </nav>

    <section id="overview">
        <h2>High-Level System Architecture</h2>
        <p>Complete view of AutonomOS showing external systems, frontend layer, API gateway, backend services, data layer, and AI integration.</p>
        <pre class="mermaid">
graph TB
    subgraph "External Systems"
        SF[Salesforce]
        HS[HubSpot]
        DY[Dynamics]
        CSV[CSV Files]
    end

    subgraph "AutonomOS Platform"
        subgraph "Frontend Layer"
            UI[React/TypeScript UI]
            DCL_UI[DCL Graph Viz]
            AAM_UI[AAM Monitor Dashboard]
        end

        subgraph "API Gateway"
            MW_TRACE[Tracing Middleware]
            MW_AUTH[Auth Middleware]
            MW_RATE[Rate Limit Middleware]
            MW_IDEMPOT[Idempotency Middleware]
            MW_AUDIT[Audit Middleware]
        end

        subgraph "Backend Services"
            API[FastAPI Server]
            DCL[DCL Engine]
            AAM[AAM Orchestrator]
            WORKER[RQ Worker]
        end

        subgraph "Data Layer"
            PG[(PostgreSQL)]
            REDIS[(Redis)]
            DUCKDB[(DuckDB)]
        end

        subgraph "AI Layer"
            GEMINI[Gemini AI]
            OPENAI[OpenAI]
            RAG[RAG Engine]
        end
    end

    SF --> AAM
    HS --> AAM
    DY --> AAM
    CSV --> AAM

    UI --> MW_TRACE
    DCL_UI --> MW_TRACE
    AAM_UI --> MW_TRACE

    MW_TRACE --> MW_AUTH
    MW_AUTH --> MW_RATE
    MW_RATE --> MW_IDEMPOT
    MW_IDEMPOT --> MW_AUDIT
    MW_AUDIT --> API

    API --> DCL
    API --> AAM
    API --> WORKER

    AAM --> PG
    DCL --> DUCKDB
    WORKER --> REDIS
    
    AAM --> GEMINI
    AAM --> OPENAI
    DCL --> RAG
        </pre>
    </section>

    <section id="dataflow">
        <h2>Data Flow: Source → AAM → DCL</h2>
        <p>End-to-end journey of data from external sources through the Adaptive API Mesh (AAM) to materialized DCL views.</p>
        <pre class="mermaid">
graph LR
    subgraph "Data Sources"
        SF_OPP[Salesforce<br/>Opportunity]
        CSV_OPP[CSV File<br/>Opportunity]
    end

    subgraph "AAM - Adaptive API Mesh"
        CONN_SF[Salesforce<br/>Connector]
        CONN_FS[FileSource<br/>Connector]
        MAP_REG[Mapping<br/>Registry]
        CANON[Canonical<br/>Schema]
        STREAM[Canonical<br/>Streams DB]
    end

    subgraph "DCL - Data Catalog Layer"
        SUB[DCL<br/>Subscriber]
        MAT[Materialized<br/>Tables]
        VIEWS[DCL Views<br/>API]
    end

    subgraph "Frontend"
        UI[React UI]
        DEBUG[Debug<br/>Endpoint]
    end

    SF_OPP -->|REST API| CONN_SF
    CSV_OPP -->|CSV Read| CONN_FS

    CONN_SF -->|Apply Mapping| MAP_REG
    CONN_FS -->|Apply Mapping| MAP_REG

    MAP_REG -->|Transform| CANON
    CANON -->|Validate| STREAM

    STREAM -->|Process| SUB
    SUB -->|Upsert| MAT

    MAT -->|Query| VIEWS
    STREAM -->|Query| DEBUG

    VIEWS --> UI
    DEBUG --> UI
        </pre>
    </section>

    <section id="aam">
        <h2>AAM (Adaptive API Mesh) Components</h2>
        <p>Three-plane architecture: Intelligence, Execution, and Control planes working together for self-healing data connectivity.</p>
        <pre class="mermaid">
graph TB
    subgraph "AAM - Adaptive API Mesh"
        subgraph "Intelligence Plane"
            ORCH[AAM Orchestrator<br/>FastAPI Service]
            DRIFT[Drift Repair Agent<br/>Self-Healing]
            SCHEMA_OBS[Schema Observer<br/>Change Detection]
            RAG_ENG[RAG Engine<br/>Semantic Search]
        end

        subgraph "Execution Plane"
            CONN_SF[Salesforce Connector]
            CONN_FS[FileSource Connector]
            CONN_PG[PostgreSQL Connector<br/>Coming Soon]
        end

        subgraph "Control Plane"
            MAP_REG[Mapping Registry<br/>YAML Configs]
            CANON_SCH[Canonical Schemas<br/>Pydantic Models]
            CONN_REG[Connector Registry<br/>PostgreSQL]
        end

        subgraph "Canonical Layer"
            CANON_ACC[CanonicalAccount]
            CANON_OPP[CanonicalOpportunity]
            CANON_CON[CanonicalContact]
            CANON_EVT[CanonicalEvent<br/>Envelope]
        end
    end

    CONN_SF --> MAP_REG
    CONN_FS --> MAP_REG
    CONN_PG -.-> MAP_REG

    MAP_REG --> CANON_SCH
    CANON_SCH --> CANON_ACC
    CANON_SCH --> CANON_OPP
    CANON_SCH --> CANON_CON

    CANON_ACC --> CANON_EVT
    CANON_OPP --> CANON_EVT
    CANON_CON --> CANON_EVT

    ORCH --> DRIFT
    ORCH --> SCHEMA_OBS
    ORCH --> RAG_ENG

    DRIFT --> CONN_REG
    SCHEMA_OBS --> CONN_REG
        </pre>
    </section>

    <section id="middleware">
        <h2>Gateway Middleware Stack</h2>
        <p>Five-layer middleware stack with request flow and routing logic.</p>
        <pre class="mermaid">
graph TD
    REQ[Incoming HTTP Request]
    
    REQ --> MW1[1. Tracing Middleware<br/>Generate trace_id]
    MW1 --> MW2[2. Auth Middleware<br/>JWT validation, tenant extraction]
    MW2 --> MW3[3. Rate Limit Middleware<br/>Per-tenant rate limiting]
    MW3 --> MW4[4. Idempotency Middleware<br/>Prevent duplicate requests]
    MW4 --> MW5[5. Audit Middleware<br/>Log all actions]
    
    MW5 --> ROUTE{Route?}
    
    ROUTE -->|/api/v1/auth| AUTH[Auth Endpoints]
    ROUTE -->|/api/v1/aoa| AOA[AOA Orchestration]
    ROUTE -->|/api/v1/aam| AAM[AAM Monitoring]
    ROUTE -->|/api/v1/filesource| FS[FileSource API]
    ROUTE -->|/api/v1/dcl/views| DCL_V[DCL Views API]
    ROUTE -->|/api/v1/debug| DEBUG[Debug Endpoints]
    ROUTE -->|/dcl| DCL[DCL Engine]
    ROUTE -->|/| STATIC[Static Frontend]
        </pre>
    </section>

    <section id="database">
        <h2>Database Schema</h2>
        <p>PostgreSQL database schema showing multi-tenant tables with relationships and key constraints.</p>
        <pre class="mermaid">
erDiagram
    USERS ||--o{ CANONICAL_STREAMS : creates
    USERS {
        int id PK
        string username
        string email
        string hashed_password
        string tenant_id
    }

    CANONICAL_STREAMS ||--o{ MATERIALIZED_ACCOUNTS : sources
    CANONICAL_STREAMS ||--o{ MATERIALIZED_OPPORTUNITIES : sources
    CANONICAL_STREAMS ||--o{ MATERIALIZED_CONTACTS : sources
    CANONICAL_STREAMS {
        int id PK
        string tenant_id
        string entity
        jsonb data
        jsonb meta
        jsonb source
        datetime emitted_at
    }

    MATERIALIZED_ACCOUNTS {
        int id PK
        string tenant_id
        string account_id UK
        string name
        string industry
        decimal annual_revenue
        int employee_count
        string website
        jsonb extras
        datetime created_at
        datetime updated_at
    }

    MATERIALIZED_OPPORTUNITIES {
        int id PK
        string tenant_id
        string opportunity_id UK
        string account_id FK
        string name
        string stage
        decimal amount
        string currency
        date close_date
        string owner_id
        int probability
        jsonb extras
        datetime created_at
        datetime updated_at
    }

    MATERIALIZED_CONTACTS {
        int id PK
        string tenant_id
        string contact_id UK
        string account_id FK
        string first_name
        string last_name
        string email
        string phone
        string title
        jsonb extras
        datetime created_at
        datetime updated_at
    }

    JOB_HISTORY {
        int id PK
        string tenant_id
        string job_id
        string job_type
        string status
        jsonb result
        datetime created_at
    }
        </pre>
    </section>

    <section id="frontend">
        <h2>Frontend Architecture</h2>
        <p>React/TypeScript frontend with real-time WebSocket updates and component hierarchy.</p>
        <pre class="mermaid">
graph TB
    subgraph "React/TypeScript Frontend"
        subgraph "Pages"
            HOME[Home Page<br/>Hero + FAQ]
            DCL_PAGE[DCL Page<br/>Graph Visualization]
            AAM_PAGE[AAM Monitor<br/>Dashboard]
            ONT_PAGE[Ontology Page<br/>Data Mappings]
        end

        subgraph "Components"
            SANKEY[Sankey Graph<br/>D3.js]
            METRICS[Metrics Cards<br/>Real-time Stats]
            CONN_TABLE[Connection Health<br/>Table]
            EVENT_LOG[Events Log<br/>Recent Activity]
        end

        subgraph "WebSocket"
            WS[DCL WebSocket<br/>Real-time Updates]
        end

        subgraph "API Clients"
            API_DCL[DCL API Client]
            API_AAM[AAM API Client]
            API_DEBUG[Debug API Client]
        end
    end

    HOME --> DCL_PAGE
    HOME --> AAM_PAGE
    HOME --> ONT_PAGE

    DCL_PAGE --> SANKEY
    AAM_PAGE --> METRICS
    AAM_PAGE --> CONN_TABLE
    AAM_PAGE --> EVENT_LOG

    DCL_PAGE --> WS
    AAM_PAGE --> API_AAM
    DCL_PAGE --> API_DCL
    AAM_PAGE --> API_DEBUG

    WS -.->|Real-time| SANKEY
    API_AAM -.->|Polling| METRICS
    API_AAM -.->|Polling| CONN_TABLE
    API_DCL -.->|On-Demand| SANKEY
        </pre>
    </section>

    <footer style="margin-top: 60px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center; color: #666;">
        <p>AutonomOS Platform - Multi-Tenant AI Orchestration Architecture</p>
    </footer>
</body>
</html>
