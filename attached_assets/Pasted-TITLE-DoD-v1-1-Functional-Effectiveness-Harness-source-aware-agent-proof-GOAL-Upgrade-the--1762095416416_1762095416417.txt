TITLE: DoD v1.1 — Functional Effectiveness Harness (source-aware, agent-proof)

GOAL
Upgrade the DoD so it FAILS when a required source isn’t configured or isn’t flowing, and so it proves the real path:
Source (SF/Supabase/Mongo/FileSource) → AAM (canonical) → DCL (views) → Agent (read + safe intent) → Journal (trace).

HARD GUARDRAILS
- No UI/CSS changes anywhere.
- Do NOT modify existing DCL transforms or graph visuals.
- Add endpoints only under /api/v1 (dev-only for debug).
- Return JSON only; never HTML errors.
- Keep existing smoke tests intact.

ENV
- Respect existing flags.
- Add: REQUIRED_SOURCES=salesforce       # comma-separated (e.g., "salesforce,supabase")
- Add: DEV_DEBUG=true                    # exposes debug endpoints in dev

PART A — Source Status (dev-only)
- Add GET /api/v1/debug/source-status → JSON:
  {
    "salesforce": { "configured": bool, "last_ingest_at": "ISO|null", "last_canonical_at": "ISO|null" },
    "supabase":   { ... },
    "mongodb":    { ... },
    "filesource": { ... }
  }
- “configured” = ENV present & connector init ok.
- last_* derived from event/journal tables by source_system.

PART B — Source-scoped last canonical
- Extend GET /api/v1/debug/last-canonical:
  Params: entity=opportunity|account (required), source=[salesforce|supabase|mongodb|filesource], limit=1 (default)
  Behavior:
    • If source provided and none found → 404 {"error":"no_canonical_for_source"}.
    • Response includes key canonical fields, emitted_at, trace_id, source_system.

PART C — Agent proofs (read + safe intent)
- Add POST /api/v1/debug/agent-proof (dev-only):
  Body: { "agent":"revops"|"finops", "entity":"opportunities"|"accounts", "intent":"noop" }
  Steps:
    1) GET /api/v1/dcl/views/{entity}?page=1&page_size=1 → expect 200
    2) POST /api/v1/intents/{agent}/execute { "intent":"noop", "dry_run":true, "explain_only":true }
       → expect {task_id, trace_id}
    3) Verify a journal row exists for that trace (or return "journal_check":"SKIPPED" if journaling async)
  Return:
    { "read":"OK", "intent":"OK", "trace_id":"...", "journal_check":"OK|SKIPPED" }

PART D — Drift demos (if connectors present)
- For Supabase:
  POST /api/v1/mesh/test/supabase/mutate { "op":"rename_column","table":"opportunities","from":"amount","to":"amount_usd" }
  → observer ticket → approve (HITL) → re-emit one row → confirm view shows amount again
- For Mongo:
  POST /api/v1/mesh/test/mongo/mutate { "op":"rename_field","collection":"opportunities","from":"amount","to":"amount_usd" }
  → observer ticket → approve → re-emit → confirm restored
- If connector not configured and REQUIRED_SOURCES includes it → mark FAIL; else print SKIPPED.

PART E — Monitor check (dev)
- Ensure MONITOR_POLLING=false in dev.
- Add/confirm GET /api/v1/monitor/metrics returns counts by source:
  { "mappings":{...},"drift":{"last_24h":{"salesforce":n1,"supabase":n2,"mongodb":n3,"filesource":n4}},"suggestions":{...},"repair":{...} }

PART F — DoD runner scripts (single-command)
- Add scripts that print EXACT lines; EXIT non-zero on failure:
  yarn dod:status          → prints SOURCE_STATUS_URL & list configured sources
  yarn dod:source <name>   → validates one source end-to-end (canonical→view)
  yarn dod:agents          → validates revops + finops read+intent+trace
  yarn dod:drift <name>    → runs drift demo for supabase|mongodb (if configured)
  yarn dod:all             → orchestrates everything per REQUIRED_SOURCES

Output lines per source validation (exact):
  DOD_SOURCE:<name>:CONFIGURED: <YES|NO>
  DOD_SOURCE:<name>:CANONICAL: <FOUND|NONE>
  DOD_SOURCE:<name>:VIEW_ROWS: <int>
  DOD_SOURCE:<name>:STATUS: <PASS|FAIL>

Output lines for agents:
  DOD_AGENT:revops:READ: <OK|FAIL>
  DOD_AGENT:revops:INTENT: <OK|FAIL> TRACE=<trace_id>
  DOD_AGENT:finops:READ: <OK|FAIL>
  DOD_AGENT:finops:INTENT: <OK|FAIL> TRACE=<trace_id>

Output lines for drift:
  DOD_DRIFT:<name>:TICKET: <RAISED|SKIPPED|FAIL>
  DOD_DRIFT:<name>:REPAIR: <APPLIED|SKIPPED|FAIL>
  DOD_DRIFT:<name>:RESTORED: <YES|NO|SKIPPED>
  DOD_DRIFT:<name>:STATUS: <PASS|SKIPPED|FAIL>

Final line:
  DOD_STATUS: <PASS|FAIL>

PART G — Enforcement
- If any source in REQUIRED_SOURCES is not configured or returns no canonical events, yarn dod:all must end with DOD_STATUS: FAIL.
- Keep existing smoke tests unchanged.

GIT
- Add code, scripts, endpoints; do not touch UI code.
- Commit: "chore(dod): functional effectiveness harness (source-aware, agent-proof)"
- Push.

OUTPUT (print ONLY)
- DOD_RUN_ALL: yarn dod:all
- DOD_RUN_SF: yarn dod:source salesforce
- DOD_RUN_AGENTS: yarn dod:agents
