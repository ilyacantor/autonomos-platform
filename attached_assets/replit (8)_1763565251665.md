# AOS Discover v2 - Hybrid Rules + AI/ML Asset Discovery

## Overview
AOS Discover v2 is a hybrid asset discovery system for Shadow IT detection and asset classification. It combines rule-based logic with AI/ML, using synthetic data from 10 "digital twin" archetypes and multi-signal feature extraction. It supports Rules-only, ML-only, and Hybrid operational modes with intelligent conflict resolution. The system provides comprehensive asset discovery, classification, enhanced security, and operational visibility, deployable as an API microservice via `/api/discover` for natural language queries, returning filtered asset data as JSON.

## User Preferences
Preferred communication style: Simple, everyday language.

## System Architecture

### Core Discovery Pipeline
The system employs a multi-mode discovery engine (rules-only, ML-only, hybrid). The rule-based engine handles priority scoring, state transitions, and exception generation, while the ML engine uses Gradient Boosting and Isolation Forest. Hybrid mode correlates outputs from both engines using configurable confidence thresholds. Data consistency is maintained by a schema-driven data model (Pydantic).

### Data Generation & Feature Engineering
Synthetic assets are generated by a digital twin simulator based on 10 YAML archetypes with configurable chaos injection. Feature extraction is multi-signal, including semantic analysis of asset IDs/URIs, authentication logs, network flow, API patterns, and configuration health. Graph-based features, derived from NetworkX, capture asset importance.

### Machine Learning Models
`sklearn.GradientBoostingClassifier` (with LightGBM fallback) is used for asset classification. `IsolationForest` is used for Shadow IT anomaly detection, trained on twin-based data splits with clamped contamination, and inference applies user-defined contamination via percentile thresholding.

### User Interface
The UI is a professional SecOps dashboard with a dark blue theme, featuring a 5-tab navigation: Main Dashboard, Triage Center, Workflow Studio, Training Center, and Experiment History. It includes real-time header statistics, a live connection pipeline visualization, a HITL Triage Queue summary, dynamic treemaps, and a live automated action log. The interface uses a responsive grid layout system with scoped CSS classes and a consistent design system (Quicksand font, specific color palette).

**Operating Instructions:** Comprehensive plain-English help modals accessible via blue "Operating Instructions" / "How to Use" buttons on Main Dashboard, Training Center, and Experiment History tabs. These provide non-technical guidance on system functionality, action definitions, metrics interpretation, best practices, and troubleshooting. Modal dialogs are dismissible via close button, ESC key, or clicking outside.

### API & CLI Interfaces
A `Typer` CLI provides commands for managing the discovery pipeline. A `FastAPI` service exposes core endpoints including `/healthz`, `/discover/run`, `/ml/train`, and `/api/discover` for NLP-based queries. Additional APIs support configuration management, training control, pipeline reset, experiment tracking, and dashboard data retrieval. Deterministic execution is ensured via a global seed in `settings.yaml`.

### Enterprise Auto-Connect
This autonomy layer automatically connects sanctioned assets to AAM using enterprise anchors (IdP, CASB, cloud inventory, procurement systems) and an authorization ledger with configurable precedence rules. Owner inference uses a 6-level cascade to identify asset owners. The AAM router connects sanctioned assets with real endpoints, including rate limiting, exponential backoff, and circuit breaker protection. A coverage predictor blocks execution if predicted coverage falls below 90%. Connector mapping supports 45+ AAM connector types.

### Background Job Orchestration
An asyncio-based job orchestration system manages long-running tasks like training and discovery. It features a `JobManager` singleton with an asyncio worker loop, job queue, progress tracking, cancellation, and JSONL persistence. API routes facilitate job submission, status, and cancellation. The system also includes production-grade observability with custom exceptions, request context tracking, structured logging, request metrics, security headers, and rate limiting middleware.

### HITL (Human-In-The-Loop) Triage Action System
A comprehensive triage system enables security analysts to make decisions on assets. The dashboard presents 4 risk-based triage queues: HIGH RISK (anomaly ≥0.7), MEDIUM RISK (0.4-0.69 anomaly), Shadow IT Risks (governor-flagged), and Data Conflicts (ML vs rule disagreements). Standard actions include Approve & Onboard, Quarantine, Review, Access Review, Block, Accept ML, Use Rule, Escalate, and Create Ticket. A dedicated Shadow IT Owner Workflow supports escalating to owner, owner approval, blocking, or review.

**State Transition Workflow:** Triage queues display ONLY unresolved assets (state: UNKNOWN or PROCESSING). When analysts resolve assets, state transitions trigger immediate queue removal: Approve & Onboard → READY_FOR_CONNECT (assets move to catalogued inventory), Quarantine/Block → PARKED (assets move to quarantined list). The dashboard reads live data from PostgreSQL, ensuring real-time state synchronization. All actions are logged to an async audit queue with full audit trails, updating asset states and metadata using PostgreSQL atomic transactions. FastAPI endpoints process triage actions with validation, error handling, and cache invalidation. Block action enforces due process requiring prior quarantine state.

### Performance Tuning
The system underwent multi-phase performance tuning, achieving 0% failure rate and P50 190ms, P95 3,900ms under load, with 30% SLO compliance. Key optimizations include: ORJSONResponse, GZipMiddleware, PyInstrument profiling, Locust load testing, AsyncTTLCache, async I/O with aiofiles, PostgreSQL migration for state management (replacing file-based storage), background periodic materialized view refresh, async HITL write queue, and refined cache invalidation. Known limitation: Database connection pool contention under 50+ concurrent users causing performance degradation.

## External Dependencies

**Core Python Libraries**
- `FastAPI` + `Uvicorn`: RESTful API
- `Typer` + `Rich`: CLI framework
- `Pydantic`: Schema validation

**Data Processing**
- `pandas`: Data manipulation
- `numpy`: Numerical operations

**Machine Learning**
- `scikit-learn`: Core ML algorithms
- `LightGBM`: Gradient boosting
- `joblib`: Model persistence

**Graph Analysis**
- `NetworkX`: Graph construction and metrics

**Utilities**
- `PyYAML`: Configuration parsing
- `orjson`: Fast JSON processing
- `Faker`: Synthetic data generation

**Enterprise Auto-Connect**
- `httpx`: Async HTTP client
- `hvac`: HashiCorp Vault client